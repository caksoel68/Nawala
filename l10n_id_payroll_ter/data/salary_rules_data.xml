<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="0">

        <record id="hr_rule_gross_id" model="hr.salary.rule">
            <field name="name">Penghasilan Bruto</field>
            <field name="sequence" eval="100"/>
            <field name="code">GROSS</field>
            <field name="category_id" ref="om_hr_payroll.GROSS"/>
            <field name="condition_select">none</field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">
# Total dari Basic + Allowance
result = categories.BASIC + categories.ALW
            </field>
        </record>

        <record id="hr_rule_pph21_ter" model="hr.salary.rule">
            <field name="name">PPh 21 (TER)</field>
            <field name="sequence" eval="150"/>
            <field name="code">PPH21_TER</field>
            <field name="category_id" ref="om_hr_payroll.DED"/>
            <field name="condition_select">python</field>
            <field name="condition_python">
# Berlaku hanya bulan 1 - 11
if payslip.date_to:
    result = payslip.date_to.month != 12
else:
    result = False
            </field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">
result = 0.0
if contract.l10n_id_ter_category:
    cat = contract.l10n_id_ter_category
    gross_amount = categories.GROSS
    
    # PERBAIKAN: Gunakan 'payslip.env' (Database Update Wajib)
    ter_obj = payslip.env['hr.payroll.ter.rate']
    
    rate = ter_obj.get_ter_rate(cat, gross_amount)
    pajak = gross_amount * (rate / 100.0)
    result = pajak
            </field>
        </record>

        <record id="hr_rule_pph21_dec" model="hr.salary.rule">
            <field name="name">PPh 21 Tahunan (Desember)</field>
            <field name="sequence" eval="151"/>
            <field name="code">PPH21_DEC</field>
            <field name="category_id" ref="om_hr_payroll.DED"/>
            <field name="condition_select">python</field>
            <field name="condition_python">
if payslip.date_to:
    result = payslip.date_to.month == 12
else:
    result = False
            </field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">
# Placeholder logic untuk bulan Desember
result = 0.0 
            </field>
        </record>

        <record id="hr_rule_net_id" model="hr.salary.rule">
            <field name="name">Net Salary</field>
            <field name="sequence" eval="200"/>
            <field name="code">NET</field>
            <field name="category_id" ref="om_hr_payroll.NET"/>
            <field name="condition_select">none</field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">
result = categories.GROSS - categories.DED
            </field>
        </record>

        <record id="structure_001_id" model="hr.payroll.structure">
            <field name="name">Gaji Bulanan Regular (TER)</field>
            <field name="code">TER_MONTHLY</field>
            <field name="company_id" ref="base.main_company"/>
            <field name="rule_ids" eval="[(6, 0, [
                ref('hr_rule_gross_id'), 
                ref('hr_rule_pph21_ter'), 
                ref('hr_rule_pph21_dec'), 
                ref('hr_rule_net_id')
            ])]"/>
        </record>

    </data>
</odoo>